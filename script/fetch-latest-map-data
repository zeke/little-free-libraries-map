#!/bin/bash
set -e

# Fetch latest Little Free Libraries map data from Google My Maps
# Source: https://www.google.com/maps/d/viewer?mid=1JXOsEi7Fhjretm6aXQEHMxdrHCk

MAP_ID="1JXOsEi7Fhjretm6aXQEHMxdrHCk"
OUTPUT_FILE="libraries.kml"
TEMP_KMZ="temp.kmz"
TEMP_DIR="temp_extract"

echo "Fetching latest map data..."

# Google My Maps KML export URL (actually returns KMZ)
curl -L "https://www.google.com/maps/d/kml?mid=${MAP_ID}" \
  -o "${TEMP_KMZ}" \
  --fail \
  --silent \
  --show-error

echo "Extracting KML from KMZ archive..."

# Extract doc.kml from the KMZ (which is a zip file)
mkdir -p "${TEMP_DIR}"
unzip -o -q "${TEMP_KMZ}" -d "${TEMP_DIR}"
mv "${TEMP_DIR}/doc.kml" "${OUTPUT_FILE}"

# Clean up
rm "${TEMP_KMZ}"
rm -rf "${TEMP_DIR}"

if [ -f "${OUTPUT_FILE}" ]; then
  FILE_SIZE=$(du -h "${OUTPUT_FILE}" | cut -f1)
  echo "✓ Successfully downloaded and extracted map data (${FILE_SIZE})"
  echo "✓ Saved to ${OUTPUT_FILE}"
else
  echo "✗ Failed to extract KML from KMZ"
  exit 1
fi
