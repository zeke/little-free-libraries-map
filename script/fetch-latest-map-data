#!/bin/bash
set -e

# Fetch latest Little Free Libraries map data from Google My Maps
# Source: https://www.google.com/maps/d/viewer?mid=1JXOsEi7Fhjretm6aXQEHMxdrHCk

MAP_ID="1JXOsEi7Fhjretm6aXQEHMxdrHCk"
OUTPUT_FILE="libraries.kml"
TEMP_DIR="temp_extract"

echo "Fetching map data..."

# Fetch map
curl -L "https://www.google.com/maps/d/kml?mid=${MAP_ID}" \
  -o "temp.kmz" \
  --fail \
  --silent \
  --show-error

echo "Extracting KML from KMZ archive..."

# Extract KMZ file
mkdir -p "${TEMP_DIR}"
unzip -o -q "temp.kmz" -d "${TEMP_DIR}"

# Move the extracted KML to the output location
mv "${TEMP_DIR}/doc.kml" "${OUTPUT_FILE}"

# Clean up
rm temp.kmz
rm -rf "${TEMP_DIR}"

if [ -f "${OUTPUT_FILE}" ]; then
  FILE_SIZE=$(du -h "${OUTPUT_FILE}" | cut -f1)
  PLACEMARK_COUNT=$(grep -c "<Placemark>" "${OUTPUT_FILE}" || echo "0")
  echo "✓ Successfully downloaded and merged map data (${FILE_SIZE})"
  echo "✓ Total placemarks: ${PLACEMARK_COUNT}"
  echo "✓ Saved to ${OUTPUT_FILE}"
else
  echo "✗ Failed to create merged KML"
  exit 1
fi
